const fs = require('fs');
const path = require('path');
const Parser = require('./parser');

class PostmanGenerator {
  constructor(options) {

    // è¯»å–é»˜è®¤é…ç½®æ–‡ä»¶
    const configPath = path.join(__dirname, '../config/node-postman-generator.json');
    const defaultConfig = fs.existsSync(configPath) ? require(configPath) : {};

    this.options = {
      routesPath: './routes',
      outputFile: './postman/collection.json',
      baseUrl: '{{base_url}}',
      ...defaultConfig,  // å…ˆåº”ç”¨é…ç½®æ–‡ä»¶ä¸­çš„é»˜è®¤å€¼
      ...options
    };
  }

  async generate() {
    console.log('ðŸš€ å¼€å§‹ç”Ÿæˆ Postman é›†åˆ...');
    fs.mkdirSync(path.dirname(this.options.outputFile), { recursive: true });

    const parser = new Parser(this.options.routesPath);
    const routes = await parser.parseRoutes();
    const collection = this.buildCollection(routes);

    fs.writeFileSync(this.options.outputFile, JSON.stringify(collection, null, 2));
    console.log(`âœ… ç”Ÿæˆå®Œæˆ: ${this.options.outputFile}`);
  }

  buildCollection(routes) {
    return {
      info: { name: "Generated API Collection", schema: "https://schema.getpostman.com/json/collection/v2.1.0/collection.json" },
      item: routes.map(route => ({
        name: `${route.method} ${route.path}`,
        request: {
          method: route.method,
          url: { raw: `${this.options.baseUrl}${route.path}` }
        }
      }))
    };
  }
}

module.exports = PostmanGenerator;
